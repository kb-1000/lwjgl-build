name: build
on: [push]

jobs:
  lwjgl3:
    strategy:
      matrix:
        os: [ubuntu-18.04, macos-10.15, windows-2019]
        version: [3.2.2]
        arch: [x64]

    env:
      LWJGL_BUILD_ARCH: ${{ matrix.arch }}
      LWJGL_BUILD_TYPE: release/${{ matrix.version }}
      MACOSX_DEPLOYMENT_TARGET: "10.9"

    runs-on: ${{ matrix.os }}
    steps:
      - name: checkout repository
        uses: actions/checkout@v2
      - run: echo ${{ runner.os }}
      - name: install dependencies (Ubuntu)
        if: ${{ runner.os == 'Linux' }}
        run: |
          sudo apt-get update
          sudo apt-get -y upgrade
          sudo apt-get -y install libgl-dev libgtk-3-dev xorg-dev libglu-dev libgl1-mesa-glx
      - name: setup jdk 8
        uses: actions/setup-java@v2
        with:
          distribution: zulu
          java-version: 8
      - name: clone LWJGL
        run: git clone -b ${{ matrix.version }} --depth 1 https://github.com/LWJGL/lwjgl3.git lwjgl3/lwjgl3
      - name: patch LWJGL
        working-directory: lwjgl3
        run: ../patcher
      - name: setup architecture variables
        shell: bash
        run: |
          if [ $LWJGL_BUILD_ARCH = x64 ]; then
              echo MSVC_ARCH=amd64 >> $GITHUB_ENV
          fi

      - name: setup macOS SDK
        if: ${{ runner.os == 'macOS' }}
        run: |
          sudo xcode-select -switch /Applications/Xcode_10.3.app
          echo "SDKROOT_PROP=-Dsdkroot=$(xcrun -sdk macosx10.14 --show-sdk-path)" >> $GITHUB_ENV
          echo "SDKROOT=$(xcrun -sdk macosx10.14 --show-sdk-path)" >> $GITHUB_ENV
      - name: run build
        working-directory: lwjgl3/lwjgl3
        if: ${{ runner.os != 'Windows' }}
        run: ant ${{ env.SDKROOT_PROP }} compile-templates clean-generated generate compile compile-native
      - name: run build (Windows)
        working-directory: lwjgl3/lwjgl3
        if: ${{ runner.os == 'Windows' }}
        shell: cmd
        run: |
          call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" ${{ env.MSVC_ARCH }} -vcvars_ver=14.16
          ant compile-templates clean-generated generate compile compile-native
